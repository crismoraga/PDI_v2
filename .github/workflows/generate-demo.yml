name: Generate demo GIF on release

on:
  release:
    types: [published]

jobs:
  build-and-generate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pillow requests wikipedia-api
      - name: Generate Celebration GIF
        run: |
          python tools/generate_celebration_gif.py
      - name: Generate Demo GIF
        run: |
          python tools/generate_demo_gif.py
      - name: Convert demo GIF to MP4 (fast start)
        run: |
          sudo apt-get update && sudo apt-get install -y ffmpeg
          ffmpeg -y -i assets/ui/demo_gif.gif -movflags faststart -pix_fmt yuv420p assets/ui/demo.mp4
      - name: Upload Celebration GIF
        uses: softprops/action-upload-release-asset@v1
        with:
          upload_url: "${{ github.event.release.upload_url }}"
          asset_path: assets/ui/celebration.gif
          asset_name: celebration.gif
          asset_content_type: image/gif
      - name: Upload Demo GIF
        uses: softprops/action-upload-release-asset@v1
        with:
          upload_url: "${{ github.event.release.upload_url }}"
          asset_path: assets/ui/demo_gif.gif
          asset_name: demo_gif.gif
          asset_content_type: image/gif
      - name: Upload Demo MP4
        uses: softprops/action-upload-release-asset@v1
        with:
          upload_url: "${{ github.event.release.upload_url }}"
          asset_path: assets/ui/demo.mp4
          asset_name: demo.mp4
          asset_content_type: video/mp4
